# The next line will trigger the script on every Windows update
# Windows version: {{ .chezmoi.windowsVersion.currentVersion }}

Write-Host "💰  Setting up WinGet packages"

$packages = '{{ .apps.winget.packages | toJson }}' | ConvertFrom-Json

Write-Host "😎  Installing/Updating applications"

# Update winget source first
winget source update

# Install or upgrade all packages
foreach ($package in $packages) {
    if ([string]::IsNullOrWhiteSpace($package)) { continue }
    
    # Check if package is already installed
    $null = winget list --id $package --exact
    if ($LASTEXITCODE -eq 0) {
        Write-Host "🔄  Updating $package"
        winget upgrade --id $package --exact --silent --accept-package-agreements --accept-source-agreements --force
    } else {
        Write-Host "📥  Installing $package"
        winget install --id $package --exact --silent --accept-package-agreements --accept-source-agreements
    }
}

Write-Host "✅  Done. All applications have been installed/updated."

Write-Host "😎  Uninstalling Microsoft Slope"

$undesiredPackageNames = '{{ .apps.winget.slope | toJson }}' | ConvertFrom-Json

# Uninstall packages if they exist
foreach ($packageName in $undesiredPackageNames) {
    if ([string]::IsNullOrWhiteSpace($packageName)) { continue }
    
    # Check if package is already installed
    $null = winget list --name $packageName
    if ($LASTEXITCODE -eq 0) {
        Write-Host "🗑️  Uninstalling $packageName"
        winget uninstall --name $packageName --silent --accept-source-agreements --force
    } else {
        Write-Host "👌  Luckly $packageName doesn't exist in the system"
    }
}

Write-Host "✅  Done. All undesired packages have been removed from the system."

Write-Host "⚠️  Unfortunately, you have to manually rerun chezmoi apply in a new terminal to capture PATH updates"

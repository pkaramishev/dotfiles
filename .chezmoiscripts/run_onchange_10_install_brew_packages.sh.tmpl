{{- if (eq .chezmoi.os "darwin") -}}
#!/bin/bash

# The next line will trigger the script on every MacOS update
# MacOS build version: {{ output "sw_vers" "--buildVersion" }}

echo "ðŸ’°  Setting up Homebrew packages"

formulae=(
    # Essentials  
    git
    nano
    wget
    curl
    python3
    zplug
    bat
    eza
    htop
    iftop
    openssl
    dockutil
    chezmoi

    # Coding tools
    {{- if (has "write_code" .use_cases) -}}
    git-delta
    git-cliff
    gitversion
    telnet
    podman
    podman-compose
    {{ end }}

    # LLM
    {{- if (has "use_llm" .use_cases) -}}
    block-goose-cli
    pygments
    {{ end }}

    # Job-specific customizations
    {{- if (has "work" .use_cases) -}}
    glab
    {{ end }}
)
casks=(
    # Essentials
    aerial
    stats
    itsycal
    google-chrome
    iterm2
    sublime-text
    font-hack-nerd-font
    bettermouse
    vlc

    # Coding tools
    {{- if (has "write_code" .use_cases) -}}
    # intellij-idea-ce -- Disabled for not because of you know what. Install OpenIDE manually instead.
    visual-studio-code
    podman-desktop
    dbeaver-community
    {{ end }}

    # LLM
    {{- if (has "use_llm" .use_cases) -}}
    block-goose
    {{ end }}

    # Private chats
    {{- if (has "chat_in_private" .use_cases) -}}
    telegram
    {{ end }}

    # Music
    {{- if (has "listen_music" .use_cases) -}}
    yandex-music
    {{ end }}

    # Job-specific customizations
    {{- if (has "work" .use_cases) -}}
    memoryanalyzer
    redis-insight
    postman
    freelens
    {{ end }}
)

brew update

echo "ðŸ˜Ž  Installing command-line applications"

# Install or upgrade all formulae
for formula in "${formulae[@]}"; do
    if brew ls --versions "$formula" >/dev/null; then
        HOMEBREW_NO_AUTO_UPDATE=1 brew upgrade --force --formula "$formula"
    else
        HOMEBREW_NO_AUTO_UPDATE=1 brew install --force --formula "$formula"
    fi
done

echo "ðŸ‘€  Installing GUI applications"

# Install or upgrade all casks
for cask in "${casks[@]}"; do
    if brew ls --versions --cask "$cask" >/dev/null; then
        HOMEBREW_NO_AUTO_UPDATE=1 brew upgrade --force --cask "$cask"
    else
        HOMEBREW_NO_AUTO_UPDATE=1 brew install --force --cask "$cask"
    fi
done

brew cleanup

echo "âœ…  Done. All applications has been installed."
{{ end }}